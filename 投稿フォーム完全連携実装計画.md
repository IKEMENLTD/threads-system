# 投稿フォーム完全連携実装計画

## 📋 現状分析

### 1. フォーム要素とデータベース対応表

| フォーム要素 | HTML ID | データベース列 | データ型 | 現在の実装状況 |
|-------------|---------|---------------|----------|-------------|
| タイトル | `postTitle` | `posts.title` | VARCHAR | ❌ **未対応** |
| 内容 | `postContent` | `posts.content` | TEXT | ✅ 対応済み |
| ハッシュタグ | `postHashtags` | `post_hashtags` | 関連テーブル | ⚠️ **部分対応** |
| 投稿日時 | `postSchedule` | `posts.scheduled_at` | TIMESTAMP | ✅ 対応済み |
| ステータス | `postStatus` | `posts.status` | ENUM | ✅ 対応済み |

### 2. 現在の問題点

#### 🔴 データベーススキーマの不整合
- フォームには`title`フィールドがあるが、データベーススキーマに`title`列がない
- ハッシュタグ処理が複雑（post_hashtags関連テーブル）

#### 🔴 フロントエンド実装の不整合
- `postTitle`フィールドのname属性が未設定
- フォーム送信処理でtitleを送信するが、APIが受け取れない

#### 🔴 API エンドポイントの不整合
- 投稿作成API でtitleフィールドを期待しているが、DBスキーマに存在しない

## 🎯 実装すべき項目

### A. データベーススキーマ修正（最優先）

```sql
-- 1. postsテーブルにtitle列を追加
ALTER TABLE posts 
ADD COLUMN title VARCHAR(200);

-- 2. titleカラムにインデックス追加
CREATE INDEX idx_posts_title ON posts(title);

-- 3. 既存データのtitle設定（投稿内容の最初の30文字）
UPDATE posts 
SET title = LEFT(content, 30) || CASE WHEN LENGTH(content) > 30 THEN '...' ELSE '' END
WHERE title IS NULL;
```

### B. フロントエンド修正

#### 1. HTML修正 (`posts.html`)
```html
<!-- name属性を追加 -->
<input type="text" id="postTitle" name="postTitle" class="form-input" placeholder="投稿タイトルを入力">
```

#### 2. JavaScript修正 (`js/pages/posts.js`)

**修正箇所1: フォーム送信処理**
```javascript
savePost: async function() {
    const formData = new FormData(this.postForm);
    
    const postData = {
        title: formData.get('postTitle') || '', // ✅ 追加
        content: formData.get('postContent'),
        hashtags: formData.get('postHashtags'),
        status: formData.get('postStatus'),
        scheduledAt: formData.get('postSchedule')
    };
    
    // バリデーション追加
    if (!postData.title.trim()) {
        this.showError('postTitle', 'タイトルは必須です');
        return;
    }
    
    // API呼び出し
    const response = await this.submitToAPI(postData);
}
```

**修正箇所2: 投稿表示処理**
```javascript
renderPost: function(post) {
    return `
        <div class="post-card" data-post-id="${post.id}">
            <div class="post-header">
                <h3 class="post-title">${this.escapeHtml(post.title)}</h3> <!-- ✅ 追加 -->
                <span class="post-status status-${post.status}">${this.getStatusText(post.status)}</span>
            </div>
            <div class="post-content">${this.escapeHtml(post.content.substring(0, 100))}...</div>
            <!-- 以下既存コード -->
        </div>
    `;
}
```

#### 3. バリデーション強化
```javascript
validatePostForm: function() {
    const title = document.getElementById('postTitle').value.trim();
    const content = document.getElementById('postContent').value.trim();
    
    // タイトル検証
    if (!title) {
        this.showError('postTitle', 'タイトルは必須です');
        return false;
    }
    if (title.length > 200) {
        this.showError('postTitle', 'タイトルは200文字以内で入力してください');
        return false;
    }
    
    // 内容検証
    if (!content) {
        this.showError('postContent', '投稿内容は必須です');
        return false;
    }
    
    return true;
}
```

### C. バックエンド API修正

#### 1. 投稿作成API (`backend/routes/posts.js`)

**修正箇所1: 作成エンドポイント**
```javascript
// POST /api/posts
router.post('/', authenticateToken, async (req, res) => {
    try {
        const { title, content, hashtags, status, scheduledAt } = req.body;
        
        // バリデーション
        if (!title?.trim()) {
            return res.status(400).json({ 
                success: false, 
                error: 'タイトルは必須です' 
            });
        }
        
        if (!content?.trim()) {
            return res.status(400).json({ 
                success: false, 
                error: '投稿内容は必須です' 
            });
        }
        
        // 投稿をDBに保存
        const { data: post, error } = await supabase
            .from('posts')
            .insert({
                user_id: req.user.id,
                title: title.trim(),           // ✅ 追加
                content: content.trim(),
                status: status || 'draft',
                scheduled_at: scheduledAt || null
            })
            .select()
            .single();
            
        if (error) {
            console.error('投稿作成エラー:', error);
            return res.status(500).json({ 
                success: false, 
                error: '投稿の作成に失敗しました' 
            });
        }
        
        // ハッシュタグ処理
        if (hashtags && hashtags.length > 0) {
            await processHashtags(post.id, hashtags);
        }
        
        res.json({ success: true, post });
        
    } catch (error) {
        console.error('投稿作成エラー:', error);
        res.status(500).json({ 
            success: false, 
            error: 'サーバーエラーが発生しました' 
        });
    }
});
```

**修正箇所2: ハッシュタグ処理関数**
```javascript
async function processHashtags(postId, hashtags) {
    for (const tag of hashtags) {
        const cleanTag = tag.replace('#', '').trim();
        if (!cleanTag) continue;
        
        // ハッシュタグを取得または作成
        let { data: hashtag } = await supabase
            .from('hashtags')
            .select('id')
            .eq('name', cleanTag)
            .single();
            
        if (!hashtag) {
            const { data: newHashtag } = await supabase
                .from('hashtags')
                .insert({ name: cleanTag })
                .select('id')
                .single();
            hashtag = newHashtag;
        }
        
        // 関連を作成
        await supabase
            .from('post_hashtags')
            .insert({
                post_id: postId,
                hashtag_id: hashtag.id
            });
    }
}
```

#### 2. 投稿取得API修正
```javascript
// GET /api/posts
router.get('/', authenticateToken, async (req, res) => {
    const { data: posts, error } = await supabase
        .from('posts')
        .select(`
            id, title, content, status, scheduled_at, created_at, updated_at,  // ✅ titleを追加
            hashtags:post_hashtags(hashtags(name))
        `)
        .eq('user_id', req.user.id)
        .order('created_at', { ascending: false });
        
    // データ整形
    const formattedPosts = posts.map(post => ({
        id: post.id,
        title: post.title || '',           // ✅ 追加
        content: post.content,
        status: post.status,
        scheduledAt: post.scheduled_at,
        createdAt: post.created_at,
        hashtags: post.hashtags?.map(h => h.hashtags.name) || []
    }));
    
    res.json({ success: true, posts: formattedPosts });
});
```

### D. CSS修正

#### 1. 投稿カードにタイトル表示 (`css/pages/posts.css`)
```css
.post-card .post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.post-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0;
    flex: 1;
    margin-right: 1rem;
}

.post-content {
    color: var(--color-text-secondary);
    line-height: 1.5;
    margin-bottom: 1rem;
}
```

## 🚀 実装順序

### フェーズ1: データベース準備（5分）
1. Supabaseでpostsテーブルにtitle列追加
2. 既存投稿のtitle自動生成

### フェーズ2: バックエンド修正（15分）
1. 投稿作成APIでtitle処理追加
2. 投稿取得APIでtitle返却
3. バリデーション強化

### フェーズ3: フロントエンド修正（20分）
1. HTMLにname属性追加
2. JavaScript送信処理修正
3. 投稿表示処理修正
4. バリデーション追加

### フェーズ4: CSS・UX改善（10分）
1. タイトル表示スタイル追加
2. エラー表示改善

## 📝 テスト項目

### 機能テスト
- [ ] タイトル付き投稿の作成
- [ ] タイトルなし投稿のエラー表示
- [ ] ハッシュタグ付き投稿
- [ ] 予約投稿の作成
- [ ] 投稿一覧での表示確認

### バリデーションテスト
- [ ] 空タイトルでの送信（エラー）
- [ ] 201文字タイトルでの送信（エラー）
- [ ] 空内容での送信（エラー）
- [ ] 正常データでの送信（成功）

### 表示テスト
- [ ] 投稿カードでのタイトル表示
- [ ] 長いタイトルの省略表示
- [ ] モバイル表示での確認

## 🔧 完了後の状態

実装完了後は以下の流れで動作します：

```
ユーザー入力 
↓
[フォーム] タイトル + 内容 + ハッシュタグ + 日時 + ステータス
↓
[JavaScript] バリデーション → FormData収集
↓
[API] POST /api/posts → データベース保存 + ハッシュタグ処理
↓
[表示] 投稿一覧に反映（タイトル付きカード表示）
```

この実装により、フォーム・データベース・APIが完全に連携し、ユーザーが入力したすべての情報が適切に保存・表示されるようになります。